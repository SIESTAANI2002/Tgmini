<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>AnimeToki</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
:root{ --accent:#7c3aed }

body{
  background:#0f172a;
  color:#e5e7eb;
  font-family:Arial;
  padding:18px;
  margin:0;
}

.card{
  background:#020617;
  border-radius:18px;
  overflow:hidden;
  border:3px solid var(--accent);
  box-shadow:
    0 0 18px var(--accent),
    0 0 40px color-mix(in srgb,var(--accent) 70%,transparent);
  transition:.4s;
}

.poster{
  width:100%;
  height:190px;
  object-fit:cover;
  object-position:center;
}

.content{ padding:13px }

.title{
  font-size:20px;
  font-weight:800;
  margin-bottom:12px;
}

.meta span{
  display:block;
  font-size:14px;
  font-weight:600;
  line-height:1.7;
}

button{
  background:linear-gradient(135deg,var(--accent),#000);
  border:none;
  padding:11px;
  border-radius:12px;
  color:white;
  font-size:16px;
  font-weight:900;
  margin-top:18px;
  cursor:pointer;
  width:100%;
  box-shadow:0 0 18px var(--accent);
}

/* ===== CINEMATIC OVERLAY ===== */
.overlay{
  position:fixed;
  inset:0;
  background:radial-gradient(circle at center,var(--accent),#000);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:999;
  opacity:0;
  pointer-events:none;
  transition:.4s;
}
.overlay.show{ opacity:1; pointer-events:auto }

.cine{
  font-size:22px;
  font-weight:900;
  animation:pulse 1.2s infinite alternate;
}

@keyframes pulse{
  from{ transform:scale(1); opacity:.7 }
  to{ transform:scale(1.08); opacity:1 }
}
</style>
</head>

<body>

<div class="card">
  <img id="poster" class="poster">

  <div class="content">
    <div class="title" id="anime">ãŠ‚ Anime</div>

    <div class="meta">
      <span id="episode">âŠ™ Episode: --</span>
      <span>âŠ™ Audio: Japanese</span>
      <span>âŠ™ Subtitle: English</span>
      <span>âŠ™ Codec: HEVC</span>
      <span id="resolution">âŠ™ Resolution: --</span>
      <span>âŠ™ Source: AnimeToki.com</span>
    </div>

    <button onclick="go()">â–¶ Watch</button>
  </div>
</div>

<div id="overlay" class="overlay">
  <div class="cine">ðŸŽ¬ Opening Episodeâ€¦</div>
</div>

<script>
const tg = Telegram.WebApp;
tg.ready(); tg.expand();

const raw = tg.initDataUnsafe?.start_param;
const decoded = atob(raw.replace(/-/g,'+').replace(/_/g,'/'));
const [anime, episode, driveId, qual, poster] = decoded.split("|");

animeEl.innerText="ãŠ‚ "+anime;
episodeEl.innerText="âŠ™ Episode: "+episode.replace("Episode ","");
resolution.innerText="âŠ™ Resolution: "+qual;

const img=document.getElementById("poster");
img.src=poster||"https://i.imgur.com/8RKXAIV.jpg";

/* ðŸŽ¨ SMART COLOR EXTRACT */
img.onload=()=>{
  const c=document.createElement("canvas"),x=c.getContext("2d");
  c.width=c.height=40;
  x.drawImage(img,0,0,40,40);
  const d=x.getImageData(0,0,40,40).data;
  let r=0,g=0,b=0,cnt=0;
  for(let i=0;i<d.length;i+=16){
    if(d[i]+d[i+1]+d[i+2]<100) continue;
    r+=d[i]; g+=d[i+1]; b+=d[i+2]; cnt++;
  }
  r=Math.floor(r/cnt); g=Math.floor(g/cnt); b=Math.floor(b/cnt);
  if(g>r && g>b) r+=40; // avoid green dominance
  document.documentElement.style.setProperty(
    "--accent",`rgb(${r},${g},${b})`
  );
};

function go(){
  overlay.classList.add("show");
  setTimeout(()=>{
    location.href=
      "player.html?anime="+encodeURIComponent(anime)+
      "&episode="+encodeURIComponent(episode)+
      "&id="+driveId+
      "&q="+qual+
      "&poster="+encodeURIComponent(poster||"");
  },2200);
}
</script>

</body>
</html>
