<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>AnimeToki Player</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    body{
      margin:0;
      background:#000;
      font-family:Arial,sans-serif;
      color:#fff;
    }

    .header{
      padding:10px;
      display:flex;
      align-items:center;
      gap:10px;
      border-bottom:1px solid #111;
    }

    .back{
      font-size:20px;
      cursor:pointer;
    }

    .title{
      font-size:14px;
      font-weight:700;
      line-height:1.4;
    }

    .player-wrap{
      position:relative;
      width:100%;
      background:#000;
    }

    video{
      width:100%;
      max-height:70vh;
      background:#000;
    }

    .controls{
      padding:12px;
      display:flex;
      gap:10px;
    }

    .btn{
      flex:1;
      padding:12px;
      border-radius:10px;
      background:#2563eb;
      font-weight:800;
      text-align:center;
      cursor:pointer;
    }

    .download{
      background:#1e90ff;
    }

    .error{
      padding:40px;
      text-align:center;
      font-weight:700;
    }
  </style>
</head>

<body>

<div class="header">
  <div class="back" onclick="history.back()">⬅</div>
  <div class="title" id="title">Loading…</div>
</div>

<div class="player-wrap">
  <video id="video" controls playsinline></video>
</div>

<div class="controls">
  <div class="btn" onclick="goFullscreen()">⛶ Fullscreen</div>
  <div class="btn download" onclick="download()">⬇ Download</div>
</div>

<script>
  const tg = Telegram.WebApp;
  tg.ready(); tg.expand();

  const raw = tg.initDataUnsafe?.start_param;
  if(!raw){
    document.body.innerHTML =
      "<div class='error'>❌ Invalid or expired link</div>";
    throw new Error("No payload");
  }

  const decoded = atob(raw.replace(/-/g,'+').replace(/_/g,'/'));
  const [anime, episode, driveId, quality] = decoded.split("|");

  document.getElementById("title").innerText =
    `${anime} • ${episode} • ${quality}`;

  /* ===== GOOGLE DRIVE DIRECT FILE =====
     ⚠️ Must be public / shared
  */
  const videoUrl =
    `https://drive.google.com/uc?export=download&id=${driveId}`;

  const video = document.getElementById("video");
  video.src = videoUrl;

  /* ===== OPTIONAL SUBTITLE (VTT) =====
     If you later add .vtt file
  */
  // const track = document.createElement("track");
  // track.kind = "subtitles";
  // track.label = "English";
  // track.srclang = "en";
  // track.src = "subtitle.vtt";
  // track.default = true;
  // video.appendChild(track);

  function goFullscreen(){
    if(video.requestFullscreen){
      video.requestFullscreen();
    }
  }

  function download(){
    Telegram.WebApp.openLink(videoUrl, {
      try_instant_view:false
    });
  }
</script>

</body>
</html>
