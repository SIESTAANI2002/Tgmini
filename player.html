<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Anime Player</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <script src='//libtl.com/sdk.js' data-zone='10350993' data-sdk='show_10350993' data-cfasync="false"></script>

  <style>
    :root{
      --accent:#3b82f6;
      --bg:#0b0b0b;
      --card:#111827;
      --text:#e5e7eb;
    }

    body{
      margin:0;
      font-family:Arial,sans-serif;
      background:var(--bg);
      color:var(--text);
    }

    /* ===== HEADER ===== */
    .header{
      padding:12px;
      display: flex;
      align-items: center;
      gap: 10px;
      background:rgba(2,6,23,.85);
      backdrop-filter:blur(6px);
      border-bottom:1px solid rgba(255,255,255,.12);
    }
    
    .back-btn {
      font-size: 20px;
      cursor: pointer;
      padding: 0 8px;
    }

    .title{
      font-size:14px;
      font-weight:800;
      line-height:1.4;
      opacity:.95;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* ===== PLAYER ===== */
    .container{
      padding:12px;
    }

    iframe{
      width:100%;
      height:220px;
      border:none;
      border-radius:14px;
      background:#000;
      box-shadow:0 10px 35px rgba(0,0,0,.6);
    }

    /* ===== BUTTONS ===== */
    .btn{
      margin-top:14px;
      padding:13px;
      border-radius:12px;
      font-size:16px;
      font-weight:800;
      text-align:center;
      cursor:pointer;
      transition:.2s ease;
      user-select:none;
      color: white;
    }

    .btn:active{
      transform:scale(.97);
    }
    
    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .stream{
      background:linear-gradient(135deg,#22c55e,#16a34a);
      box-shadow:0 6px 22px rgba(34,197,94,.45);
    }

    .download{
      background:linear-gradient(135deg,#3b82f6,#2563eb);
      box-shadow:0 6px 22px rgba(59,130,246,.45);
    }
  </style>
</head>

<body>

<div class="header">
  <div class="back-btn" onclick="history.back()">⬅️</div>
  <div class="title" id="title">Loading...</div>
</div>

<div class="container">
  <iframe id="player" allow="autoplay; encrypted-media" allowfullscreen></iframe>

  <button id="streamBtn" class="btn stream" onclick="handleAdClick('stream')">
    ▶️ Stream Fullscreen
  </button>

  <button id="dlBtn" class="btn download" onclick="handleAdClick('download')">
    ⬇️ Download Episode
  </button>
</div>

<script>
  const tg = Telegram.WebApp;
  tg.ready();
  tg.expand();
  tg.BackButton.show();
  tg.BackButton.onClick(() => history.back());

  // ১. URL থেকে ডাটা সংগ্রহ করা
  const params = new URLSearchParams(window.location.search);
  const driveId = params.get("id");
  const animeTitle = params.get("title") || "Anime Video";
  const episodeNum = params.get("ep") || "";

  // ২. টাইটেল এবং প্লেয়ার সেট করা
  if(driveId){
    document.getElementById("title").innerText = `${animeTitle} ${episodeNum ? "• " + episodeNum : ""}`;
    document.getElementById("player").src = `https://drive.google.com/file/d/${driveId}/preview`;
  } else {
    document.getElementById("title").innerText = "Error: No Video Found";
  }

  // ==========================================
  // ✅ AD LOGIC FOR ALL BUTTONS
  // ==========================================

  function handleAdClick(type) {
    let btn;
    if (type === 'stream') btn = document.getElementById("streamBtn");
    else btn = document.getElementById("dlBtn");

    if (!driveId) { alert("Video source missing!"); return; }
    
    // বাটন লক করা
    if(btn.disabled) return;
    const originalText = btn.innerText;
    btn.disabled = true;
    btn.innerText = "Please Wait..."; // লোডারের বদলে টেক্সট

    let actionDone = false;

    // আসল কাজ করার ফাংশন (Action)
    const performAction = () => {
        if(actionDone) return;
        actionDone = true;

        // বাটন রিসেট (যদি ইউজার ব্যাকে আসে)
        btn.innerText = originalText;
        btn.disabled = false;

        if (type === 'stream') {
             // Stream Logic
             // এখানে আপনার stream.html পেজে নিয়ে যাবে
             location.href = "stream.html"; 
        } else {
             // Download Logic
             const downloadUrl = `https://drive.google.com/uc?export=download&id=${driveId}`;
             tg.openLink(downloadUrl);
        }
    };

    // ১. ৫ সেকেন্ড টাইমার (Safety)
    const timer = setTimeout(() => {
        console.log("Ad timeout, performing action...");
        performAction();
    }, 5000);

    // ২. Monetag অ্যাড কল
    try {
        if (typeof show_10350993 === 'function') {
            console.log("Loading Ad...");
            show_10350993().then(() => {
                console.log("Ad Finished");
                clearTimeout(timer);
                performAction();
            }).catch((e) => {
                console.log("Ad Failed/No Fill");
                clearTimeout(timer);
                performAction();
            });
        } else {
            console.log("SDK not ready");
            clearTimeout(timer);
            performAction();
        }
    } catch (e) {
        clearTimeout(timer);
        performAction();
    }
  }
</script>

</body>
</html>
