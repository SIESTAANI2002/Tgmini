<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Anime Player</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root{
      --accent:#3b82f6;
      --bg:#0b0b0b;
      --card:#111827;
      --text:#e5e7eb;
    }

    body{
      margin:0;
      font-family:Arial,sans-serif;
      background:var(--bg);
      color:var(--text);
    }

    /* ===== HEADER ===== */
    .header{
      padding:12px;
      text-align:center;
      background:rgba(2,6,23,.85);
      backdrop-filter:blur(6px);
      border-bottom:1px solid rgba(255,255,255,.12);
    }

    .title{
      font-size:14px;
      font-weight:800;
      line-height:1.4;
      letter-spacing:.3px;
      opacity:.95;
    }

    /* ===== PLAYER ===== */
    .container{
      padding:12px;
    }

    iframe{
      width:100%;
      height:220px;
      border:none;
      border-radius:14px;
      background:#000;
      box-shadow:0 10px 35px rgba(0,0,0,.6);
    }

    /* ===== BUTTONS ===== */
    .btn{
      margin-top:14px;
      padding:13px;
      border-radius:12px;
      font-size:16px;
      font-weight:800;
      text-align:center;
      cursor:pointer;
      transition:.2s ease;
      user-select:none;
    }

    .btn:active{
      transform:scale(.97);
    }

    .stream{
      background:linear-gradient(135deg,#22c55e,#16a34a);
      box-shadow:0 6px 22px rgba(34,197,94,.45);
    }

    .download{
      background:linear-gradient(135deg,#3b82f6,#2563eb);
      box-shadow:0 6px 22px rgba(59,130,246,.45);
    }

    /* ===== LOADER ===== */
    .loader{
      position:fixed;
      inset:0;
      background:rgba(2,6,23,.9);
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      z-index:999;
      opacity:0;
      pointer-events:none;
      transition:.3s;
    }

    .loader.show{
      opacity:1;
      pointer-events:auto;
    }

    .spinner{
      width:54px;
      height:54px;
      border:5px solid #1e293b;
      border-top-color:var(--accent);
      border-radius:50%;
      animation:spin 1s linear infinite;
      margin-bottom:16px;
    }

    @keyframes spin{
      to{transform:rotate(360deg)}
    }

    .loader p{
      font-weight:700;
      opacity:.9;
    }
  </style>
</head>

<body>

<!-- HEADER -->
<div class="header">
  <div class="title" id="title">Loading...</div>
</div>

<!-- PLAYER -->
<div class="container">
  <iframe id="player"></iframe>

  <div class="btn stream" onclick="openStream()">
    ▶️ Stream Fullscreen
  </div>

  <div class="btn download" onclick="downloadFile()">
    ⬇️ Download
  </div>
</div>

<!-- LOADER -->
<div id="loader" class="loader">
  <div class="spinner"></div>
  <p>Preparing your episode…</p>
</div>

<script>
  const tg = Telegram.WebApp;
  tg.ready();
  tg.expand();

  const raw = tg.initDataUnsafe?.start_param;
  if(!raw){
    document.body.innerHTML="❌ Invalid request";
    throw new Error("No payload");
  }

  const decoded = atob(raw.replace(/-/g,'+').replace(/_/g,'/'));
  const [title, episode, driveId, quality] = decoded.split("|");

  document.getElementById("title").innerText =
    `${title} • ${episode} • ${quality}`;

  const previewUrl =
    `https://drive.google.com/file/d/${driveId}/preview?rm=minimal`;

  document.getElementById("player").src = previewUrl;

  function openStream(){
    location.href = "stream.html";
  }

  function downloadFile(){
    const downloadUrl =
      `https://drive.google.com/uc?export=download&id=${driveId}`;

    Telegram.WebApp.openLink(downloadUrl,{
      try_instant_view:false
    });
  }
</script>

</body>
</html>
