<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>AnimeToki Player</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root{
      --bg:#000;
      --card:#020617;
      --text:#e5e7eb;
      --accent:#3b82f6;
    }

    body.light{
      --bg:#f8fafc;
      --card:#ffffff;
      --text:#020617;
    }

    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:Arial,sans-serif;
      transition:.3s;
    }

    /* ===== HEADER ===== */
    .header{
      display:flex;
      align-items:center;
      gap:10px;
      padding:12px;
      border-bottom:1px solid rgba(255,255,255,.12);
    }
    body.light .header{
      border-bottom:1px solid rgba(0,0,0,.12);
    }

    .back{
      font-size:20px;
      cursor:pointer;
    }

    .title{
      font-size:14px;
      font-weight:700;
      line-height:1.4;
    }

    /* ===== PLAYER ===== */
    .container{
      padding:12px;
    }

    iframe{
      width:100%;
      height:220px;
      border:none;
      border-radius:12px;
      background:#000;
    }

    /* ===== BUTTONS ===== */
    .btn{
      margin-top:12px;
      padding:12px;
      border-radius:10px;
      font-size:16px;
      font-weight:800;
      text-align:center;
      cursor:pointer;
      user-select:none;
    }

    .stream{
      background:linear-gradient(135deg,#22c55e,#16a34a);
      color:#fff;
    }

    .download{
      background:linear-gradient(135deg,#3b82f6,#1d4ed8);
      color:#fff;
    }

    /* ===== LOADER ===== */
    .loader{
      position:fixed;
      inset:0;
      background:rgba(2,6,23,.88);
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      z-index:999;
      opacity:0;
      pointer-events:none;
      transition:.3s;
    }
    .loader.show{
      opacity:1;
      pointer-events:auto;
    }

    body.light .loader{
      background:rgba(255,255,255,.95);
    }

    .spinner{
      width:48px;
      height:48px;
      border:5px solid #1e293b;
      border-top-color:var(--accent);
      border-radius:50%;
      animation:spin 1s linear infinite;
      margin-bottom:14px;
    }

    body.light .spinner{
      border:5px solid #cbd5f5;
      border-top-color:var(--accent);
    }

    @keyframes spin{
      to{transform:rotate(360deg)}
    }

    .loader p{
      font-weight:700;
      color:#e5e7eb;
    }
    body.light .loader p{
      color:#020617;
    }

    /* ===== ERROR ===== */
    .error{
      padding:40px;
      text-align:center;
      font-weight:700;
    }
  </style>
</head>

<body>

<!-- LOADER -->
<div id="loader" class="loader">
  <div class="spinner"></div>
  <p>Loading player…</p>
</div>

<!-- HEADER -->
<div class="header">
  <div class="back" onclick="goBack()">⬅</div>
  <div class="title" id="title">Anime</div>
</div>

<!-- CONTENT -->
<div class="container">

  <iframe id="player"></iframe>

  <div class="btn stream" onclick="openStream()">
    ▶️ Stream Fullscreen
  </div>

  <div class="btn download" onclick="downloadFile()">
    ⬇️ Download
  </div>

</div>

<script>
  const tg = Telegram.WebApp;
  tg.ready();
  tg.expand();

  if(tg.colorScheme === "light"){
    document.body.classList.add("light");
  }

  const loader = document.getElementById("loader");
  loader.classList.add("show");

  // ===== PAYLOAD =====
  const raw = tg.initDataUnsafe?.start_param;
  if(!raw){
    document.body.innerHTML =
      "<div class='error'>❌ Invalid or expired link</div>";
    throw new Error("No payload");
  }

  const decoded = atob(raw.replace(/-/g,'+').replace(/_/g,'/'));
  const [anime, episode, driveId, quality] = decoded.split("|");

  document.getElementById("title").innerText =
    `${anime} • ${episode} • ${quality}`;

  const previewUrl =
    `https://drive.google.com/file/d/${driveId}/preview?rm=minimal`;

  const iframe = document.getElementById("player");
  iframe.src = previewUrl;

  iframe.onload = () => {
    loader.classList.remove("show");
  };

  // ===== ACTIONS =====
  function goBack(){
    history.back();
  }

  function openStream(){
    window.location.href = "stream.html?id=" + driveId;
  }

  function downloadFile(){
    const url =
      `https://drive.google.com/uc?export=download&id=${driveId}`;
    Telegram.WebApp.openLink(url,{try_instant_view:false});
  }
</script>

</body>
</html>
